<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡æ¿ç”Ÿæˆ - æ–‡æ¡£æ ¼å¼åŒ–ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .mode-switch {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .mode-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .mode-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .mode-btn.active {
            background: white;
            color: #667eea;
            font-weight: bold;
        }

        .main-card {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .template-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .template-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
            transform: translateY(-3px);
        }

        .template-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        }

        .template-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .template-card .category {
            display: inline-block;
            background: #f0f0f0;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            color: #666;
            margin-bottom: 10px;
        }

        .template-card p {
            color: #666;
            font-size: 0.95em;
            line-height: 1.5;
        }

        .template-details {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .template-details.show {
            display: block;
        }

        .template-details h4 {
            color: #333;
            margin-bottom: 15px;
        }

        .section-list {
            list-style: none;
            padding: 0;
        }

        .section-list li {
            padding: 8px 0;
            color: #555;
            border-bottom: 1px solid #e0e0e0;
        }

        .section-list li:last-child {
            border-bottom: none;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .form-group textarea,
        .form-group select,
        .form-group input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }

        .form-group small {
            display: block;
            color: #888;
            margin-top: 5px;
            font-size: 0.9em;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #c33;
        }

        .success-message {
            background: #efe;
            color: #3c3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3c3;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .nav-buttons {
            text-align: center;
            margin-top: 30px;
        }

        .nav-btn {
            display: inline-block;
            padding: 10px 20px;
            margin: 0 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            border-radius: 20px;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ æ¨¡æ¿ç”Ÿæˆç³»ç»Ÿ</h1>
            <p>é€‰æ‹©æ¨¡æ¿ï¼Œå¡«å†™è¦ç‚¹ï¼ŒAI ç”Ÿæˆæ–‡æ¡£</p>
        </div>

        <div class="mode-switch">
            <button class="mode-btn" onclick="window.location.href='/segment/'">æ–‡æ¡£åˆ†å‰²</button>
            <button class="mode-btn active">æ¨¡æ¿ç”Ÿæˆ</button>
        </div>

        <div class="main-card">
            {% if error %}
            <div class="error-message">
                {{ error }}
            </div>
            {% endif %}

            <form id="templateForm" method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- æ¨¡æ¿é€‰æ‹© -->
                <div class="form-group">
                    <label>é€‰æ‹©æ¨¡æ¿</label>
                    <div class="template-grid">
                        {% for template_id, name, category, template_type in templates %}
                        <div class="template-card" data-template-id="{{ template_id }}">
                            <h3>{{ name }}</h3>
                            <span class="category">{{ category }}</span>
                            <p>{% if template_type == 'system' %}ç³»ç»Ÿæ¨¡æ¿{% else %}è‡ªå®šä¹‰æ¨¡æ¿{% endif %}</p>
                        </div>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="template_id" id="templateId" required>
                </div>

                <!-- æ¨¡æ¿è¯¦æƒ… -->
                <div class="template-details" id="templateDetails">
                    <h4>æ¨¡æ¿ç»“æ„</h4>
                    <ul class="section-list" id="sectionList">
                        <!-- åŠ¨æ€åŠ è½½ -->
                    </ul>
                </div>

                <!-- ç”¨æˆ·è¦ç‚¹ -->
                <div class="form-group">
                    <label for="userOutline">æ–‡æ¡£è¦ç‚¹</label>
                    <textarea
                        name="user_outline"
                        id="userOutline"
                        placeholder="è¯·è¾“å…¥æ–‡æ¡£è¦ç‚¹æˆ–å¤§çº²ï¼Œä¾‹å¦‚ï¼š&#10;- å®Œæˆäº†3ä¸ªé¡¹ç›®ï¼Œæå‡äº†20%æ•ˆç‡&#10;- åŸ¹è®­äº†2åæ–°äºº&#10;- ä¼˜åŒ–äº†å›¢é˜Ÿå·¥ä½œæµç¨‹&#10;- æ˜å¹´ç›®æ ‡ï¼šæå‡æŠ€æœ¯èƒ½åŠ›"
                        required
                    ></textarea>
                    <small>è¯·æä¾›æ‚¨å¸Œæœ›åŒ…å«åœ¨æ–‡æ¡£ä¸­çš„å…³é”®è¦ç‚¹ï¼ŒAI å°†æ ¹æ®è¿™äº›è¦ç‚¹ç”Ÿæˆå®Œæ•´å†…å®¹</small>
                </div>

                <!-- å¯é€‰ï¼šä¸Šä¼ æºæ–‡æ¡£ -->
                <div class="form-group">
                    <label for="sourceDocument">æºæ–‡æ¡£ï¼ˆå¯é€‰ï¼‰</label>
                    <input
                        type="file"
                        name="source_document"
                        id="sourceDocument"
                        accept=".docx"
                    >
                    <small>å¦‚æœæä¾›äº†æºæ–‡æ¡£ï¼ŒAI å°†å°è¯•ä»ä¸­æå–ç›¸å…³å†…å®¹ã€‚å¦åˆ™å°†æ ¹æ®è¦ç‚¹ç”Ÿæˆæ¡†æ¶ã€‚</small>
                </div>

                <!-- è¯­è°ƒé€‰æ‹© -->
                <div class="form-group">
                    <label for="tone">æ–‡æ¡£è¯­è°ƒ</label>
                    <select name="tone" id="tone">
                        <option value="no_preference">é»˜è®¤</option>
                        <option value="direct">ç®€æ´ç›´æ¥</option>
                        <option value="rigorous">ä¸¥è°¨ä¸“ä¸š</option>
                        <option value="empathetic">äº²åˆ‡æ¸©æš–</option>
                        <option value="inspirational">é¼“èˆäººå¿ƒ</option>
                        <option value="humorous">è½»æ¾æœ‰è¶£</option>
                        <option value="cold_sharp">æƒå¨æœæ–­</option>
                    </select>
                    <small>é€‰æ‹©æ–‡æ¡£çš„è¯­è°ƒé£æ ¼</small>
                </div>

                <!-- æäº¤æŒ‰é’® -->
                <button type="submit" class="submit-btn" id="submitBtn">
                    ç”Ÿæˆæ–‡æ¡£
                </button>
            </form>
        </div>

        <div class="nav-buttons">
            <a href="/" class="nav-btn">è¿”å›é¦–é¡µ</a>
            <a href="/segment/" class="nav-btn">æ–‡æ¡£åˆ†å‰²</a>
        </div>
    </div>

    <script>
        let selectedTemplate = null;

        // æ¨¡æ¿å¡ç‰‡ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.template-card').forEach(card => {
            card.addEventListener('click', function() {
                // ç§»é™¤å…¶ä»–å¡ç‰‡çš„é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));

                // é€‰ä¸­å½“å‰å¡ç‰‡
                this.classList.add('selected');
                selectedTemplate = this.dataset.templateId;
                document.getElementById('templateId').value = selectedTemplate;

                // åŠ è½½æ¨¡æ¿è¯¦æƒ…
                loadTemplateDetails(selectedTemplate);
            });
        });

        // åŠ è½½æ¨¡æ¿è¯¦æƒ…
        function loadTemplateDetails(templateId) {
            const detailsDiv = document.getElementById('templateDetails');
            const sectionList = document.getElementById('sectionList');

            sectionList.innerHTML = '<div class="loading"><div class="loading-spinner"></div>åŠ è½½ä¸­...</div>';
            detailsDiv.classList.add('show');

            fetch(`/api/template/${templateId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayTemplateSections(data.template);
                    } else {
                        sectionList.innerHTML = '<li style="color: #c33;">åŠ è½½å¤±è´¥: ' + data.error + '</li>';
                    }
                })
                .catch(error => {
                    sectionList.innerHTML = '<li style="color: #c33;">åŠ è½½å¤±è´¥: ' + error + '</li>';
                });
        }

        // æ˜¾ç¤ºæ¨¡æ¿ç« èŠ‚
        function displayTemplateSections(template) {
            const sectionList = document.getElementById('sectionList');
            sectionList.innerHTML = '';

            function addSections(sections, level = 0) {
                sections.forEach(section => {
                    const li = document.createElement('li');
                    const indent = '&nbsp;&nbsp;&nbsp;&nbsp;'.repeat(level);
                    const optional = section.is_optional ? ' (å¯é€‰)' : '';

                    li.innerHTML = `${indent}${section.title}${optional}`;

                    if (section.subsections && section.subsections.length > 0) {
                        addSections(section.subsections, level + 1);
                    }

                    sectionList.appendChild(li);
                });
            }

            if (template.sections && template.sections.length > 0) {
                addSections(template.sections);
            }
        }

        // è¡¨å•æäº¤
        document.getElementById('templateForm').addEventListener('submit', function(e) {
            // éªŒè¯æ¨¡æ¿é€‰æ‹©
            if (!selectedTemplate) {
                e.preventDefault();
                alert('è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡æ¿');
                return false;
            }

            // éªŒè¯ç”¨æˆ·è¦ç‚¹
            const outline = document.getElementById('userOutline').value.trim();
            if (!outline) {
                e.preventDefault();
                alert('è¯·è¾“å…¥æ–‡æ¡£è¦ç‚¹');
                return false;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ç”Ÿæˆä¸­...';

            // æäº¤è¡¨å•
            return true;
        });

        // æ–‡ä»¶é€‰æ‹©æç¤º
        document.getElementById('sourceDocument').addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                const small = this.parentElement.querySelector('small');
                small.textContent = `å·²é€‰æ‹©: ${file.name} (${fileSize} MB) - AI å°†å°è¯•ä»ä¸­æå–å†…å®¹`;
            }
        });
    </script>
</body>
</html>
